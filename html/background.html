<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<script type="text/javascript" src="/js/jquery-1.4.2.min.js"></script>
<script type="text/javascript" src="/js/eventMap.js"></script>
<script type="text/javascript" src="/js/atnd.js"></script>
<script type="text/javascript" src="/js/timer.js"></script>
<script type="text/javascript" src="/js/notification.js"></script>
<script type="text/javascript" src="/js/options.js"></script>
<script type="text/javascript">
var options = Options.load();
var notification = new Notification('html/notification.html', 1000 * options.autoCloseTimeSS);
var timer = new Timer(1000 * 60 * options.timerMI); // n分に一回
function main(options) {
	timer.start(function () {
		console.log("timer run");
		console.log(options);
		updateUserEventList(options);
		eventUserStatusNotify(options);
		eventStartDateNotifyAndEventUpdateNotify(options);
		keywordNotify(options);
		ownerNotify(options);
	});
}
main(options);

// 参加イベントの一覧を更新する
function updateUserEventList(options) {
	var events = Atnd.findByUserId(options.user_id);
	var map = new EventMap(options.user_events);
	events.forEach(function (event) {
		var userEvent = map.get(event.event_id);
		if (userEvent == null) {
			var status = 0;
			event.users.forEach(function (user) {
				if (options.user_id == user.user_id) {
					status = user.status;
				}
			});
			map.put({event_id:event.event_id, title:event.title, status:status, updated_at:event.updated_at, dateNotifiedList:[]});
		} else if (userEvent.status == 0 && event.status == 1) {
			userEvent.status = 1;
		}
	});
	options.user_events = map.toArray();
	options.user_events.forEach(function (userEvent) {
		if (userEvent.started_at != null) {
			return;
		}
		var atnd = new Atnd(userEvent.event_id);
		var event = atnd.getEvent();
		if (event == null) {
			return;
		}
		userEvent.started_at = event.started_at;
		userEvent.ended_at = event.ended_at;
		userEvent.owner_id = event.owner_id;
		userEvent.owner_nickname = event.owner_nickname;
		userEvent.accepted = event.accepted;
		userEvent.limit = event.limit;
		userEvent.waiting = event.waiting;
		userEvent.address = event.address;
		userEvent.lon = event.lon;
		userEvent.lat = event.lat;
		addEventCalendarList(options, event);
	});
	options.save();
}

// イベントの開催日時が近づいたら通知、イベントに変更があったら通知
function eventStartDateNotifyAndEventUpdateNotify(options) {

	// 終了していないイベントを抽出
	var eventList = Atnd.filterIsNotEndedEventList(options.user_events);
	var now = new Date();
	eventList.forEach(function (userEvent) {
		console.debug(userEvent);
		var atnd = new Atnd(userEvent.event_id);
		var event = atnd.getEvent();
		if (event == null) {
			return;
		}
		addEventCalendarList(options, event);
		userEvent.started_at = event.started_at;
		userEvent.ended_at = event.ended_at;
		userEvent.accepted = event.accepted;
		userEvent.limit = event.limit;
		userEvent.waiting = event.waiting;
		userEvent.address = event.address;
		userEvent.lon = event.lon;
		userEvent.lat = event.lat;


		// 何日前に備忘通知
		var eventDate = Atnd.toDate(event.started_at);
		var isNotified = false;
		options.dateNotifyList.forEach(function (dateNotify) {
			if ($.inArray(dateNotify, userEvent.dateNotifiedList) > -1) {
				return; // 過去に通知済み
			}
			var sai = (now - eventDate) * -1; // 差分ミリ秒数
			var time = (1000 * 60 * 60 * 24) * dateNotify;
			if (time >= sai) {
				if (!isNotified) {
					notification.open({event_id:event.event_id, title:event.title, msg:"(備忘通知)開催日時：" + eventDate.toISOString().substring(0, 10)});
					isNotified = true;
				}
				userEvent.dateNotifiedList.push(dateNotify);
			}
		});

		if (event.updated_at > userEvent.updated_at) {
			userEvent.updated_at = event.updated_at;
			notification.open({event_id:event.event_id, title:event.title, msg:"イベント内容に変更がありました"});
		}
	});

	options.save();
}

// キャンセル待ち→出席になったら通知
function eventUserStatusNotify(options) {
	// 終了していないイベントを抽出
	var eventList = Atnd.filterIsNotEndedEventList(options.user_events);
	eventList.forEach(function (userEvent) {
		console.debug(userEvent);
		if (userEvent.status == 1) {
			return; // 既に出席
		}
		var atnd = new Atnd(userEvent.event_id);
		var status = atnd.getStatus(options.user_id);
		if (status == 1) {
			userEvent.status = 1; // キャンセル待ち→出席
			notification.open({event_id:userEvent.event_id, title:userEvent.title, msg:"参加できるようになりました"});
		}
	});
	options.save();
}

// 特定キーワードを含むイベントが見つかったら通知する
function keywordNotify(options) {
	var list = [];
	options.keywordList.forEach(function (keyword){
		console.debug("keyword:" + keyword);
		var events = Atnd.findByKeyword(keyword);
		events.forEach(function (event){
			addEventCalendarList(options, event);
			if ($.inArray(event.event_id, options.keywordNotifiedList) == -1) {
				list.push(keyword);
				options.keywordNotifiedList.push(event.event_id);
			}
		});
	});
	$.each($.unique(list), function (i, keyword) {
		// TODO:○件のイベントが見つかりました。に変更する。
		notification.open({title:keyword, msg: "イベントが見つかりました。アイコンをクリックしてカレンダーを確認してください。"});
	});
	options.save();
}

// 特定の管理人がイベントを立てたら通知する
function ownerNotify(options) {
	options.ownerList.forEach(function (owner){
		console.debug(owner);
		var events = Atnd.findByOwnerId(owner.user_id);
		events.forEach(function (event){
			addEventCalendarList(options, event);
			if (Atnd.toDate(owner.updated_at) < Atnd.toDate(event.updated_at)) {
				owner.updated_at = event.updated_at;
				if ($.inArray(event.event_id, options.ownerNotifiedList) == -1) {
					notification.open({event_id:event.event_id, title:event.title, msg:owner.nickname + "さんが新規イベントを作成しました。"});
					options.ownerNotifiedList.push(event.event_id);
				}
			}
		});
	});
	options.save();
}

function addEventCalendarList(options, event) {
	// TODO:更新されていた場合はeventを差し替える必要あり
	var isHave = false;
	options.eventCalendarList.forEach(function (e, i) {
		if (e.event_id == event.event_id) {
			isHave = true;
		}
	});
	if (!isHave) {
		event.attention = true;
		options.eventCalendarList.push(event);
	}
}

// notification.html, content_scripts.jsとのメッセージ送受信イベント割り当て
chrome.extension.onRequest.addListener(function(message, sender, sendResponse){
	console.debug(message);
	if (message.id === 'content_script_options') {
		sendResponse(options);
	} else if (message.id === 'content_script_userId') {
		options.user_id = message.userId;
		options.user_nickname = message.nickname;
		options.save();
		sendResponse();
	} else if (message.id === 'content_script_ownerId') {
		if (!message.isDelete) {
			// 通知設定
			var now = new Date();
			options.ownerList.push({user_id:message.ownerId, nickname:message.ownerNickname, updated_at:now.toISOString().substring(0,10) + "T" + now.toLocaleTimeString()});
		} else {
			// 通知解除
			var list = [];
			$.each(options.ownerList, function (i, owner){
				if (message.ownerId != owner.user_id) {
					list.push(ownerId);
				}
			});
			options.ownerList = list;
		}
		options.save();
		sendResponse();
	} else {
		// notification.html
		sendResponse(notification.getItem(message.id));
	}
});
</script>
</head>
<body>
</body>
</html>